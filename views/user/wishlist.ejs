<link rel="stylesheet" href="/css/profile.css">
<%- include('../../views/partials/user/header') %>

<script src="https://cdn.tailwindcss.com"></script>
<style>
  @keyframes fadeSlideUp {
    0% {
      opacity: 0;
      transform: translateY(20px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-slide-up {
    animation: fadeSlideUp 0.6s ease-out forwards;
  }

  .animate-fade-in {
    animation: fadeIn 0.5s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
</style>

<div class="container mx-auto px-6 py-12">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    
    <!-- Sidebar -->
    <div class="bg-white p-6 rounded-lg shadow-md min-h-[500px] flex flex-col">
      <ul class="space-y-2">
        <li><a href="/profile" class="block py-2 px-4 rounded hover:bg-gray-200">Profile</a></li>
        <li><a href="/order" class="block py-2 px-4 rounded hover:bg-gray-200">My Orders</a></li>
        <li><a href="/address" class="block py-2 px-4 rounded hover:bg-gray-200">Manage Address</a></li>
        <li><a href="/wishlist" class="block py-2 px-4 rounded bg-gray-100 font-semibold">WishList</a></li>
        <li><a href="/wallet" class="block py-2 px-4 rounded hover:bg-gray-200">Wallet</a></li>
      </ul>
      <button class="mt-auto w-full bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-700" onclick="logout()">Logout</button>
    </div>

    <!-- Wishlist Section -->
    <div class="col-span-2 bg-white p-6 rounded-lg shadow-md h-[590px] relative flex flex-col animate-fade-in">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-800">My Wishlist</h2>

        <!-- Search Bar -->
        <div class="relative">
          <input 
            type="text" 
            id="searchInput" 
            placeholder="Search wishlist..." 
            class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent"
            onkeyup="searchWishlist()"
          >
          <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>

      <% if (!wishlistItems || wishlistItems.length === 0) { %>
        <div class="flex-grow flex items-center justify-center">
          <div class="text-center space-y-4">
            <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18M9.879 9.879a3 3 0 104.242 4.242M6 21h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm9-10V7a3 3 0 00-6 0v4"></path>
            </svg>
            <h3 class="text-lg font-semibold text-gray-700">Your wishlist is empty</h3>
            <p class="text-gray-500">Looks like you haven’t added anything yet.</p>
            <a href="/shop" class="inline-block bg-gray-800 hover:bg-gray-700 text-white px-5 py-2 rounded-lg transition text-sm font-medium">
              Shop Now
            </a>
          </div>
        </div>
      <% } else { %>
        <div class="flex-grow overflow-y-auto scrollbar-hide pr-2 pb-16" id="wishlistContainer">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <% wishlistItems.forEach((item, index) => {
              let product = item;
              let imgSrc = product.images && product.images.length > 0 ? `/uploads/product-images/${product.images[0]}` : '/images/default.jpg';
            %>
              <div 
                class="border rounded-xl p-3 hover:shadow-md transition-all bg-white fade-slide-up h-68 flex flex-col justify-between opacity-0"
                data-wishlist-id="<%= product.id %>"
                data-variant-index="<%= product.variantIndex %>"
                style="animation-delay: <%= (index * 0.1) %>s"
              >
                <img src="<%= imgSrc %>" alt="Product Image" class="w-full h-28 object-cover rounded-md">
                <div class="flex-1 flex flex-col justify-between mt-2">
                  <div>
                    <h3 class="font-semibold text-gray-800 text-sm mb-1"><%= product.name %></h3>
                    <p class="text-xs text-gray-500">Brand: <%= product.brand %></p>
                    <% if (product.category) { %>
                      <p class="text-xs text-gray-500">Category: <%= product.category.name %></p>
                    <% } %>
                    <% if (product.variantName) { %>
                      <p class="text-xs text-gray-500">Variant: <%= product.variantName %></p>
                    <% } %>
                    <p class="text-xs text-gray-500 mt-1">Price: ₹<%= product.price %></p>
                  </div>
                  <div class="flex justify-between items-center mt-3">
                    <button class="bg-gray-800 text-white text-xs px-3 py-1 rounded hover:bg-gray-700" onclick="viewProduct('<%= product.id %>')">
                      Quick View
                    </button>
                    <button class="bg-red-600 text-white text-xs px-3 py-1 rounded hover:bg-red-700" 
                            onclick="removeFromWishlist('<%= product.id %>', <%= product.variantIndex %>)">
                      Remove
                    </button>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function searchWishlist() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const cards = document.querySelectorAll('#wishlistContainer .fade-slide-up');
    cards.forEach(card => {
      const name = card.querySelector('h3').textContent.toLowerCase();
      card.style.display = name.includes(input) ? '' : 'none';
    });
  }

  async function removeFromWishlist(productId, variantIndex) {
    const confirm = await Swal.fire({
      title: 'Remove from Wishlist?',
      text: 'Are you sure you want to remove this product?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, remove it!',
      cancelButtonText: 'Cancel',
      reverseButtons: true
    });

    if (confirm.isConfirmed) {
      try {
        const response = await fetch('/wishlist', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId, variantIndex })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Removed!',
            text: 'Product removed from wishlist.',
            timer: 1500,
            showConfirmButton: false
          }).then(() => {
            // Optionally remove the card from UI without reloading
            const card = document.querySelector(`[data-wishlist-id="${productId}"][data-variant-index="${variantIndex}"]`);
            if (card) card.remove();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Failed',
            text: data.message || 'Could not remove the item.',
          });
        }
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: 'An unexpected error occurred.',
        });
      }
    }
  }

  function viewProduct(productId) {
    window.location.href = `/shopDetails?id=${productId}`;
  }

  function logout() {
    window.location.href = '/logout';
  }
</script>

<%- include('../../views/partials/user/footer') %>
